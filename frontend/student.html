<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Student - Attendance</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
  body { font-family:'Poppins',sans-serif; margin:0; background:#f0f2f5; display:flex; min-height:100vh; }
  .container { display:flex; width:100%; }
  .sidebar { width:220px; background:linear-gradient(180deg,#4B6CB7,#182848); color:white; padding:20px; }
  .sidebar h3 { margin-bottom:20px; font-size:20px; }
  .sidebar ul { list-style:none; padding:0; }
  .sidebar li { padding:10px; cursor:pointer; border-radius:5px; margin-bottom:10px; transition:background 0.2s; }
  .sidebar li:hover { background:#3A539B; }
  .main { flex:1; padding:20px; }
  header { margin-bottom:20px; font-size:18px; }
  .card { background:white; padding:20px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.1); margin-bottom:20px; }
  #reader { margin-top:10px; border-radius:10px; overflow:hidden; }
  #timer { font-size:18px; margin-top:10px; font-weight:bold; color:#ff3b3b; }
  select { margin-top:10px; padding:5px; border-radius:5px; }
  table { width:100%; border-collapse:collapse; margin-top:10px; }
  th, td { border:1px solid #ccc; padding:8px; text-align:left; }
  th { background-color:#f0f0f0; }
  .attendance-present { color:#28a745; font-weight:bold; }
  #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
  .toast { background:#333; color:white; padding:15px 20px; margin-top:10px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.2); opacity:0; transform:translateX(100%); transition:all 0.5s ease; min-width:250px; }
  .toast.show { opacity:1; transform:translateX(0); }
  .toast.success { background:#28a745; }
  .toast.error { background:#dc3545; }
  .toast.info { background:#007bff; }
</style>
</head>
<body>
<div class="container">
  <aside class="sidebar">
    <h3>Attendance</h3>
    <ul>
      <li id="nav-scan">üì∑ Scan QR</li>
      <li id="nav-my">üìä My Attendance</li>
      <li id="logout">üö™ Log Out</li>
    </ul>
  </aside>

  <main class="main">
    <header>Welcome, <span id="usern"></span></header>

    <section id="scan-section" class="card">
      <h3>Scan QR (‚è± 10s)</h3>
      <label for="subjectSelect">Choose Subject:</label>
      <select id="subjectSelect">
        <option value="">--Select--</option>
        <option value="NMSA">NMSA</option>
        <option value="DS">DS</option>
        <option value="CN">CN</option>
        <option value="EMSI">EMSI</option>
        <option value="PFM">PFM</option>
      </select>
      <div id="reader" style="width:300px; height:300px;"></div>
      <div id="timer"></div>
    </section>

    <section id="my-section" class="card" style="display:none;">
      <h3>My Attendance</h3>
      <div id="stats"></div>
    </section>
  </main>
</div>

<div id="toast-container"></div>

<script>
// ---------------- Student JS ----------------
const token = localStorage.getItem("token") || "demoToken";
const username = localStorage.getItem("username") || "Student1";
document.getElementById("usern").innerText = username;

let html5QrCode = null;
let countdownInterval = null;
let scanning = false;

// Toast function
function showToast(message, type="info", duration=3000){
  const container = document.getElementById("toast-container");
  const toast = document.createElement("div");
  toast.className = "toast " + type + " show";
  toast.innerText = message;
  container.appendChild(toast);
  setTimeout(()=>{ toast.classList.remove("show"); toast.remove(); }, duration);
}

// Sidebar
document.getElementById("nav-scan").addEventListener("click", ()=> {
  document.getElementById("scan-section").style.display="block";
  document.getElementById("my-section").style.display="none";
  startScanner();
});

document.getElementById("nav-my").addEventListener("click", ()=> {
  document.getElementById("scan-section").style.display="none";
  document.getElementById("my-section").style.display="block";
  document.getElementById("stats").innerHTML = `
    <table>
      <thead>
        <tr><th>Student ID</th><th>Name</th><th>Subject</th><th>Date & Time</th><th>Attendance</th></tr>
      </thead>
      <tbody id="attendance-body"></tbody>
    </table>`;
  stopScanner();
  fetchAttendance();
});

document.getElementById("logout").addEventListener("click", ()=> {
  localStorage.clear();
  window.location.href="index.html";
});

// Start QR scanner
function startScanner(){
  const subject = document.getElementById("subjectSelect").value;
  if(!subject){ 
    showToast("‚ö†Ô∏è Please select a subject first","error"); 
    return; 
  }

  if(scanning) return;
  scanning = true;

  if(!html5QrCode) html5QrCode = new Html5Qrcode("reader");

  let timeLeft = 10;
  document.getElementById("timer").innerText = `Time Left: ${timeLeft}s`;

  countdownInterval = setInterval(()=>{
    timeLeft--;
    document.getElementById("timer").innerText = `Time Left: ${timeLeft}s`;
    if(timeLeft <= 0){
      clearInterval(countdownInterval);
      stopScanner();
      showToast("‚è≥ Scan timed out!","info");
    }
  },1000);

  html5QrCode.start(
    {facingMode:"environment"},
    {fps:10, qrbox:250},
    (decodedText)=>{
      clearInterval(countdownInterval);
      stopScanner();
      document.getElementById("timer").innerText="";
      showToast(`‚úÖ Attendance marked for ${subject}`,"success");

      // ----------------- Backend call -----------------
      // Accept test QR codes directly
      let qrValue = decodedText.startsWith("TEST-") ? subject : decodedText;

      fetch("http://localhost:5002/mark-attendance", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({ subject, qrCode: qrValue })
      })
      .then(res=>res.json())
      .then(data=>{
        if(data.success){
          showToast(`‚úÖ Attendance saved at ${data.time}`,"success");
        }else{
          showToast(`‚ö†Ô∏è ${data.message}`,"error");
        }
      })
      .catch(err=>{
        console.error(err);
        showToast("‚ùå Server error","error");
      });

      setTimeout(()=> scanning=false, 1000);
    },
    ()=>{}
  ).catch(err=>{
    clearInterval(countdownInterval);
    scanning = false;
    document.getElementById("timer").innerText="";
    showToast("‚ö†Ô∏è Please allow camera access!","error");
    console.error("Camera error:",err);
  });
}

// Stop scanner
function stopScanner(){
  if(html5QrCode && html5QrCode._isScanning){
    html5QrCode.stop().then(()=> html5QrCode.clear()).catch(err=>console.error("Stop error:",err));
  }
  clearInterval(countdownInterval);
  document.getElementById("timer").innerText="";
  scanning=false;
}

// Fetch attendance
function fetchAttendance(){
  fetch("http://localhost:5002/my-attendance", { headers: { "Authorization": `Bearer ${token}` }})
  .then(res=>res.json())
  .then(data=>{
    const tbody=document.getElementById("attendance-body");
    tbody.innerHTML="";
    data.attendance.forEach(rec=>{
      const row=`<tr>
        <td>${rec.studentId || "TBIT"+Math.floor(10000+Math.random()*90000)}</td>
        <td>${username}</td>
        <td>${rec.subject}</td>
        <td>${rec.date} ${rec.time}</td>
        <td class="attendance-present">Present</td>
      </tr>`;
      tbody.insertAdjacentHTML("beforeend",row);
    });
  })
  .catch(err=>console.error("Error fetching attendance:",err));
}

// Auto start scanner on page load
window.addEventListener("load", startScanner);
</script>
</body>
</html>
